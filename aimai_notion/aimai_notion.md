yokoyです。
[書名・著者名・出版社名]であいまい検索をして結果をHTMLで表示し、選んだ本をnotionデータベースに登録するショートカットを作成したので手順を公開します。

[ここに動画を挿入]

こんな人におすすめです

- **Notionで書籍管理を行いたい**
- **Notionで書籍管理を行なっているけど、、**
    - **表紙の画像を探してダウンロードするのがめんどくさい**
    - **タイトルとか著者名のコピペがめんどくさい**

## 有料部分について
本記事には有料パートがありますが、無料パートだけでショートカットを作成可能です。
無料部分で作成手順を解説しており、有料部分には作成済のショートカットのリンクを載せています。
「作るのはめんどくさい」「とにかく早く使いたい」という人は有料版の購入をお勧めいたします。

## 目次

## 記事を書いた経緯

カメラを起動してISBNを読み取るショートカットレシピはいくつか存在しますが、あいまい検索によるNotionへの書籍追加ショートカットは見つかりませんでした。
私は持っていないけど読みたい本もNotionで管理しているので、手元に無い本もショートカット経由で簡単にNotionに追加したいなというモチベーションで本ショートカットを作成しました。

## 想定読者

- **Notionのアカウントを持っている**
- **iPhoneユーザである**
- **Notionで書籍管理を行いたい**
    - **表紙の画像を探してダウンロードするのがめんどくさい**
    - **タイトルとか著者名のコピペがめんどくさい**

## 事前準備

ショートカットの作成に入る前に4つの事前準備が必要です
（有料版を購入される場合も、この準備は必要になります）

* **ショートカットアプリのインストール**
* **データベースの作成とIDの取得**
* **notionインテグレーションキーの取得**
* **楽天ブックスAPIの登録**

それぞれの手順については、手前味噌で恐縮ですが以下の記事を参照してください

https://note.com/tender_roses92/n/nc49d8f8c6168

## ショートカットの作成

ではここからショートカットを作成する手順を説明していきます
スクショがメインですが、適宜説明も入れています
スクショ下の箇条書きは使用しているアクション名です

### 各種変数の設定

[images/shortcut_set_hensu1.png]

* テキスト
* 変数を設定

3回繰り返します
事前準備で取得した各種idをここに入力してください

### タイトル・著者・出版社の入力を要求 

### タイトル・著者・出版社すべて空白の場合はエラー

### APIに渡すURLを生成

### APIを叩いて結果を取得

[images/shortcut_get_APIresponse1.png]

* URLの内容を取得

例えば、ISBN=9784088900827の本を検索したときの結果はこんな感じ
（長すぎるので一部抜粋しています）

```
{
  "GenreInformation": [],
  "Items": [
    {
      "Item": {
        "publisherName": "集英社",
        "seriesName": "ヤングジャンプコミックス",
        "title": "ゴールデンカムイ 1",
        "itemUrl": "https://books.rakuten.co.jp/rb/13062647/?rafcid=wsc_b_bs_1018165179551203384",
        "size": "コミック",
        "largeImageUrl": "https://thumbnail.image.rakuten.co.jp/@0_mall/book/cabinet/0827/9784088900827.jpg?_ex=200x200",
        "isbn": "9784088900827",
        "itemPrice": 594,
        "salesDate": "2015年01月19日頃",
        "author": "野田サトル",
      }
    }
  ],
  "count": 1,
  "first": 1
}
```

### （おまけ）検索結果が無い場合の処理

[images/shortcut_if_nobook1.png]

* 辞書の値を取得
* 入力から数字を取得
* if文
    * アラートを表示
    * このショートカットを停止

### 複数の検索結果ごとに情報を取得

先ほど取得したJSONからタイトルや著者名などの情報を変数に格納します

[images/shortcut_get_APIresponse2.png]

* 辞書の値を取得
* リストから項目を取得
* 辞書の値を取得
* 変数を設定
* 辞書の値を取得
* 変数を設定（以下、繰り返し）

### 繰り返し内でHTML用のブロックを作っておく

このショートカットではあいまい検索の結果をHTML形式で出力し、
目的の書籍のISBNをユーザーがクリップボードにコピーします。
そして、ショートカットがクリップボードの中身を取得し、
もう一度APIを叩いて書籍情報をNotionに登録します。

まずはあいまい検索結果を表示するHTML用のブロックを作っておきます。
後ほどこのブロックをもとに検索結果が並んだHTMLを作成します。

### クリップボードの中身をクリアしておく

もしあいまい検索の結果、目的の書籍が見つからなかった場合、ユーザーはISBNをコピーせずにHTMLをcloseします。
このとき、前回に本ショートカットを実行してコピーしたISBNがクリップボードに残っていると、再度その本がNotionに追加されてしまいます。
それを回避するため、ここでクリップボードの中身を一旦空にします。
と言いたいところですが、空にする方法が分からなかったので今日の日付を入れています。

### Notionデータベースに登録

[images/shortcut_add_notion1.png]

* テキスト
* 変数を設定

[images/shortcut_add_notion2.png]

* URLの内容を取得
* アラートを表示

おつかれさまでした！
ショートカットの設定は以上になります

## 動作チェック

実際にショートカットを実行してみます。
実行するだけで自動でカメラが起動します。

> 本の裏にバーコードが2つある場合は、下側を指で隠して撮影してください  
下のバーコードが読み取られた場合は検索にヒットしません

初めてショートカットを実行した場合は、APIの使用許可を聞かれるポップアップが出現することがありますが、「許可」をタップしてください。

## ショートカットリンク

これまでのショートカット作成手順を再現するのがめんどくさいという人は、
ここからの有料版を購入してください。

- **トラブル回避のため、”事前準備”をすべて完了した上でご購入をお願い致します。**
- **本ショートカットはiOS18.3で動作確認を実施しています。**
- **これより古いver.では正常に動作しない可能性があることをご理解の上、ご購入をお願い致します。**
- **ショートカットをダウンロードしたのち、事前準備で取得したID類をショートカット内に入力する作業は必要となりますので、ご理解のほどよろしくお願い致します。**

では、以下がショートカットリンクになります。

https://www.icloud.com/shortcuts/9e4b300b17624513806420a94a481b4e

[images/add_shortcut.png]

上記リンクを開き、
「ショートカットを追加」をクリックしてください

### 事前準備で取得したid類の登録

ショートカットを開き、idの部分をあなたのidに書き換えます。
まずはショートカットアプリを開いてください。

[images/added_shortcut.png]

すべてのショートカットの一番上に【共有】ISBN読取→Notionというショートカットができているはずです。
ショートカット右上の3点リーダをタップしてください。

[images/shortcut_set_hensu1.png]

XXXXXXを削除し、それぞれ適切なid, キーをコピペしてください。
ここが間違っていると正常に動作しないので間違えないよう注意してください。
3箇所すべて書き換えられたら、「完了」を押して終了です。

> ちなみに左上のアイコンやショートカット名をタップすることで自由にアイコンや名前を変更できます

### ショートカットの実行

では実際にショートカットを実行します。
やり方は簡単です、ショートカットアプリから【共有】ISBN読取→Notionのショートカットをタップするだけ！
自動でカメラが起動するのでお手元の本の裏のバーコードを読み取ってください

> 本の裏にバーコードが2つある場合は、下側を指で隠して撮影してください  
下のバーコードが読み取られた場合は検索にヒットしません

[images/realbook.png]


初めてショートカットを実行した場合は、APIの使用許可を聞かれるポップアップが出現することがありますが、「許可」をタップしてください。

検索がうまくいけば、「"本のタイトル"をnotionに追加しました！」と表示が出ます。
notionに移動し、データベースを開いてみましょう。
無事、バーコード読取した書籍が追加されていれば成功です。

> 「をnotionに追加しました！」と表示される場合はidの入力がうまくいってない可能性が高いです。
もう一度、applicationidを見直してみてください。
「本が見つかりませんでした」と表示される場合は、楽天ブックスAPI内に無い書籍を読み込んでいます。
別の本でもう一度試してみてください。

**ショートカットが動かない場合のチェックポイント**

- APIキーやデータベースIDなどが間違っていないか？
- iOSのバージョンが最新か？
- iCloudが有効になっているか（「設定」>「Apple ID」>「iCloud」>「ショートカット」がオンになっていること）
- 以上を全て試しsafariでiCloudリンクを開き直す

上記を試しても正常に動作しない場合は、お手数ですが以下のリンクを参考にクリエイターページから問い合わせをお願い致します。

[https://note.com/info/n/n033f422de5bb]

このショートカットがみなさまのお役に立てることを祈っております。
